"use client"
import { useRef, useState, useEffect, useCallback, useMemo } from 'react'
import Link from 'next/link'
import { useRouter } from 'next/navigation'
import { GoogleMap, MarkerF, PolylineF, useJsApiLoader } from "@react-google-maps/api"
import { getRandomPoint } from "./test-scripts/randpoint.js"
import styles from "./page.module.css"
import { useAudio } from '@/components/AudioProvider'

const CAMPUS_MAP_BOUNDS = { north: 40.2, south: 40.0, east: -88.1, west: -88.3 }
const MAP_CENTER = { lat: 40.1106, lng: -88.2073 }
const MAX_ROUNDS = 3
const MAX_SCORE = 5000
const INITIAL_TIMER_SECONDS = 119
const GOOGLE_MAPS_LIBRARIES = ['places']
const GOOGLE_MAPS_API_KEY = "AIzaSyAsEYGOKBJHsMyWQ4QvAqAmI_BQm7vxpAk"

const SCORE_BAR_CONFIG = { LINE_WIDTH: 50, LINE_Y: 35, LEFT_MARGIN: 0.1, RIGHT_MARGIN: 0.9, TICK_MULTIPLIER: 3, ACCELERATION: 0.01, WIDTH_RATIO: 0.8, OFFSET: 30 }
const SCORE_BAR_COLORS = { background: "#3e5ab3", track: "#5b6369", fill: "#cd870e" }
const DEFAULT_POSITION = { lat: 0, lng: 0 }

function calculateDistance(lat1, lon1, lat2, lon2) { const R=6371; const dLat=(lat2-lat1)*Math.PI/180; const dLon=(lon2-lon1)*Math.PI/180; const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2; return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a)); }
const MAX_DISTANCE_IN_BOUNDS = calculateDistance(CAMPUS_MAP_BOUNDS.south,CAMPUS_MAP_BOUNDS.west,CAMPUS_MAP_BOUNDS.north,CAMPUS_MAP_BOUNDS.east)
function formatTimer(seconds){const m=Math.floor(seconds/60);const s=(seconds%60).toString().padStart(2,"0");return `${m}:${s}`}
function calculateScore(distance,maxDistance=MAX_DISTANCE_IN_BOUNDS){const n=Math.min(distance/maxDistance,1);return Math.max(0,Math.floor(MAX_SCORE*(1-n)))}
function getMapZoom(distance){if(distance>5)return 12; if(distance>1)return 14; return 16}
function getMapCenter(goalPoint,guessPoint){const has=guessPoint&&!isDefaultPosition(guessPoint); if(!has) return goalPoint||MAP_CENTER; return {lat:(goalPoint.lat+guessPoint.lat)/2,lng:(goalPoint.lng+guessPoint.lng)/2}}
function isDefaultPosition(p){return p?.lat===0&&p?.lng===0}
const createPosition=(lat,lng)=>({lat,lng})
function formatDistanceText(distance,has){const d=distance.toFixed(2);return has?`Your guess was ${d}km from the correct location!`:`No guess placed! Distance: ${d}km`}

function useStreetViewPanorama(isLoaded,ref){
  const [goalPoint,setGoalPoint]=useState(null)
  const panoRef=useRef(null)
  const ensureInit=useCallback(()=>{ if(panoRef.current) return true; if(!window.google?.maps) return false; const c=ref.current||document.querySelector('[data-panorama-container]'); if(!c) return false; try{ panoRef.current=new window.google.maps.StreetViewPanorama(c); return true }catch{return false} },[ref])
  const findValid=useCallback((pt)=>{ if(!window.google?.maps) return; ensureInit(); const svc=new window.google.maps.StreetViewService(); const process=({data})=>{ const ok=data.copyright?.indexOf("Google")>=0; if(!ok){ const r=getRandomPoint(); const np=createPosition(r.lat,r.long); setGoalPoint(np); svc.getPanorama({location:np,radius:1000}).then(process); return } const loc=data.location.latLng; const final=createPosition(loc.lat(),loc.lng()); setGoalPoint(final); const pano=panoRef.current; if(pano?.setPano){ try{ pano.setPano(data.location.pano); pano.setVisible(true); pano.setOptions({zoomControl:true,linksControl:true,addressControl:false,panControl:false,showRoadLabels:false}); }catch{} } }; svc.getPanorama({location:pt,radius:1000}).then(process) },[ensureInit])
  const adjust=useCallback((d)=>{const p=panoRef.current; if(p?.getZoom)p.setZoom(p.getZoom()+d)},[])
  const zoomIn=useCallback(()=>adjust(1),[adjust]); const zoomOut=useCallback(()=>adjust(-1),[adjust])
  useEffect(()=>{ if(!isLoaded||!window.google) return; ensureInit(); const r=getRandomPoint(); const p=createPosition(r.lat,r.long); setGoalPoint(p); findValid(p) },[isLoaded,ensureInit,findValid])
  return {goalPoint:goalPoint, findValidPanorama:findValid, zoomIn, zoomOut}
}

function useTimer(initialSeconds,onTimeout){ const [seconds,setSeconds]=useState(initialSeconds); const cb=useRef(onTimeout); useEffect(()=>{cb.current=onTimeout},[onTimeout]); useEffect(()=>{ if(seconds<=0){cb.current(); return} const i=setInterval(()=>setSeconds(v=>v<=1?0:v-1),1000); return ()=>clearInterval(i) },[seconds]); const reset=useCallback((s=initialSeconds)=>setSeconds(s),[initialSeconds]); return {seconds,reset,formatted:formatTimer(seconds)} }

function useScoreBarAnimation(show,score,onComplete){ const canvasRef=useRef(null); const [eff,setEff]=useState(0); useEffect(()=>{ if(score&&typeof score==='string'){ const v=parseInt(score.replace('pts',''),10)||0; setEff(v)}},[score]); useEffect(()=>{ if(!show||!canvasRef.current||eff===0){ if(!show&&onComplete) onComplete(); return } const canvas=canvasRef.current; const ctx=canvas.getContext('2d'); const w=typeof window!=='undefined'?window.innerWidth:800; canvas.width=w; let t=0, acc=0, done=false; const {WIDTH_RATIO,LINE_WIDTH,LINE_Y,LEFT_MARGIN,RIGHT_MARGIN,TICK_MULTIPLIER,ACCELERATION,OFFSET}=SCORE_BAR_CONFIG; const target=((WIDTH_RATIO*w)/TICK_MULTIPLIER)*(eff/MAX_SCORE)-OFFSET; const startX=LEFT_MARGIN*w; const endX=RIGHT_MARGIN*w; const draw=()=>{ if(t>target){ if(!done&&onComplete){done=true; onComplete()} return false } t+=1+acc; acc+=ACCELERATION; ctx.fillStyle=SCORE_BAR_COLORS.background; ctx.fillRect(0,0,w,50); ctx.beginPath(); ctx.lineWidth=LINE_WIDTH; ctx.strokeStyle=SCORE_BAR_COLORS.track; ctx.lineCap='round'; ctx.moveTo(startX,LINE_Y); ctx.lineTo(endX,LINE_Y); ctx.stroke(); ctx.beginPath(); ctx.lineWidth=LINE_WIDTH; ctx.strokeStyle=SCORE_BAR_COLORS.fill; ctx.lineCap='round'; ctx.moveTo(startX,LINE_Y); ctx.lineTo(startX+(t*TICK_MULTIPLIER),LINE_Y); ctx.stroke(); return true}; const interval=setInterval(()=>{ if(!draw()) clearInterval(interval) },1); return ()=>{ clearInterval(interval); if(!done&&onComplete) onComplete() } },[show,eff,onComplete]); return canvasRef }

function useGameLogic(goalPoint){ const [userGuess,setUserGuess]=useState(DEFAULT_POSITION); const [submittedGuess,setSubmittedGuess]=useState(null); const [submittedGoal,setSubmittedGoal]=useState(null); const [score,setScore]=useState(null); const [guessInfo,setGuessInfo]=useState(null); const submitGuess=useCallback(()=>{ if(!goalPoint) return; const has=!isDefaultPosition(userGuess); const guessPos=has?userGuess:null; const dist=guessPos?calculateDistance(guessPos.lat,guessPos.lng,goalPoint.lat,goalPoint.lng):MAX_DISTANCE_IN_BOUNDS; const sc=calculateScore(dist); setScore(`${sc}pts`); setGuessInfo(formatDistanceText(dist,has)); setSubmittedGoal(goalPoint); setSubmittedGuess(guessPos||DEFAULT_POSITION) },[goalPoint,userGuess]); const resetGuess=useCallback(()=>{ setUserGuess(DEFAULT_POSITION); setSubmittedGuess(null); setSubmittedGoal(null); setScore(null); setGuessInfo(null) },[]); return {userGuess,submittedGuess,submittedGoal,score,guessInfo,setUserGuess,submitGuess,resetGuess} }

function UIOverlay({timerText,currentRound}){ return (<div id={styles["overlay"]}><Link href="/lobby"><img src="./logo.png" style={{maxHeight:"60px"}} alt="Logo"/></Link><div id={styles["timer"]}>{timerText}</div><div id={styles["roundCounter"]}>Round {currentRound}</div></div>) }
function ControlOverlay({onZoomIn,onZoomOut}){ return (<div id={styles.controlsOverlay}><button id={styles["zoomIn"]} onClick={onZoomIn}>+</button><button id={styles["zoomOut"]} onClick={onZoomOut}>-</button></div>) }

function useMapMarker(mapRef){ const markerRef=useRef(null); const update=useCallback((pos,pan=true)=>{ if(!mapRef.current||!window.google?.maps) return; if(markerRef.current){ markerRef.current.setMap(null); markerRef.current=null } if(pos&&!isDefaultPosition(pos)){ markerRef.current=new window.google.maps.Marker({position:pos,map:mapRef.current,title:'Guess position',animation:window.google.maps.Animation.DROP}); if(pan){ mapRef.current.panTo(pos); mapRef.current.setZoom(18) } } },[mapRef]); return {updateMarker:update} }

function GuessMap({isLoaded,userGuess,onMapClick,isExpanded,onToggleExpand,onSubmitGuess}){ const mapRef=useRef(null); const {updateMarker}=useMapMarker(mapRef); const style=useMemo(()=>({width:isExpanded?'600px':'400px',height:isExpanded?'600px':'400px',marginLeft:"200px",marginBottom:"15px",transition:'width 0.3s ease, height 0.3s ease'}),[isExpanded]); const onLoad=useCallback((m)=>{mapRef.current=m;m.setCenter(MAP_CENTER);m.setZoom(16)},[]); const onClick=useCallback((e)=>{const pos=createPosition(e.latLng.lat(),e.latLng.lng()); updateMarker(pos,true); onMapClick(pos)},[updateMarker,onMapClick]); useEffect(()=>{ if(mapRef.current&&userGuess){ updateMarker(userGuess,false)} },[userGuess,updateMarker]); if(!isLoaded){ return (<div id={styles["guessOverlay"]}><div>Loading map...</div><button onClick={onSubmitGuess}>Submit guess!</button></div>) } return (<div id={styles["guessOverlay"]}><GoogleMap mapContainerStyle={style} defaultCenter={MAP_CENTER} defaultZoom={16} onClick={onClick} onLoad={onLoad} onDblClick={onToggleExpand} options={{streetViewControl:false,disableDoubleClickZoom:true}}/><button style={{width:"400px",marginLeft:"200px"}} onClick={onSubmitGuess}>Submit guess!</button></div>) }

function ScoreScreen({show,score,guessInfo,goalPoint,guessPoint,isLoaded,onNextRound,onScoreBarComplete,currentRound}){ const router=useRouter(); const complete=currentRound>MAX_ROUNDS; const scorebarRef=useScoreBarAnimation(show,score,onScoreBarComplete); const onBtn=useCallback(()=>{ if(complete) router.push('/profile'); else onNextRound() },[complete,router,onNextRound]); if(!show){ return (<div style={{visibility:"hidden",display:"none"}}><canvas id={styles["fillScorebar"]} height="10" width="70" ref={scorebarRef}/></div>) } const dist=guessPoint&&!isDefaultPosition(guessPoint)?calculateDistance(guessPoint.lat,guessPoint.lng,goalPoint.lat,goalPoint.lng):0; const center=getMapCenter(goalPoint,guessPoint); const zoom=getMapZoom(dist); return (<div id={styles.scoreScreen}><img src="./logo.png" style={{maxHeight:"60px",marginRight:"calc(100% - 70px)"}} alt="Logo"/>{isLoaded&&goalPoint&&(<GoogleMap mapContainerStyle={{width:'75vw',height:'400px',marginLeft:"12.5vw",marginBottom:"10px"}} center={center} zoom={zoom} options={{streetViewControl:false}}><MarkerF position={goalPoint} title="Correct Location" icon={{url:"http://maps.google.com/mapfiles/ms/icons/green-dot.png"}}/>{guessPoint&&!isDefaultPosition(guessPoint)&&(<><MarkerF position={guessPoint} title="Your Guess" icon={{url:"http://maps.google.com/mapfiles/ms/icons/red-dot.png"}}/><PolylineF path={[goalPoint,guessPoint]} geodesic options={{strokeColor:"#ff2527",strokeOpacity:0.75,strokeWeight:2}}/></>)} </GoogleMap>)}<div id={styles["roundInformation"]}></div><div id={styles["scoreBar"]}><div id={styles["score"]}>{score}</div><canvas id={styles["fillScorebar"]} height="70" width={typeof window!=='undefined'?window.innerWidth:800} ref={scorebarRef}/><div id={styles["guessInfo"]}>{guessInfo}</div><button onClick={onBtn}>{complete?"Return to profile page":"Start next!"}</button></div></div>) }

export default function Gameplay(){ const [showScoreScreen,setShowScoreScreen]=useState(false); const [currentRound,setCurrentRound]=useState(1); const [isMapExpanded,setIsMapExpanded]=useState(false); const panoramaRef=useRef(null); const scoreAddStartedRef=useRef(false); const hasMarkerPlacedRef=useRef(false); const { isLoaded } = useJsApiLoader({id:'google-map-script',googleMapsApiKey:GOOGLE_MAPS_API_KEY,libraries:GOOGLE_MAPS_LIBRARIES}); const { playEffect,startMusic,ensureAudio,startScoreAdd,stopScoreAdd }=useAudio(); useEffect(()=>{ ensureAudio(); startMusic() },[ensureAudio,startMusic]); const {goalPoint,findValidPanorama,zoomIn,zoomOut}=useStreetViewPanorama(isLoaded,panoramaRef); const gameLogic=useGameLogic(goalPoint); const { seconds:timerSeconds, reset:resetTimer, formatted:timerText }=useTimer(INITIAL_TIMER_SECONDS,()=>handleSubmitGuess()); const stopScoreAudio=useCallback(()=>{ if(scoreAddStartedRef.current){ scoreAddStartedRef.current=false; stopScoreAdd() } },[stopScoreAdd]); const handleSubmitGuess=useCallback(()=>{ playEffect("submit"); gameLogic.submitGuess(); setCurrentRound(p=>p+1); setShowScoreScreen(true); setTimeout(()=>playEffect("score"),100) },[gameLogic,playEffect]); const handleMapClick=useCallback((pos)=>{ playEffect("place"); gameLogic.setUserGuess(pos); hasMarkerPlacedRef.current=true },[gameLogic,playEffect]); const handleScoreBarComplete=useCallback(()=>{ stopScoreAudio() },[stopScoreAudio]); const startRound=useCallback(()=>{ if(currentRound>MAX_ROUNDS) return; stopScoreAudio(); playEffect("place"); const r=getRandomPoint(); const newGoal=createPosition(r.lat,r.long); gameLogic.resetGuess(); setShowScoreScreen(false); resetTimer(INITIAL_TIMER_SECONDS); findValidPanorama(newGoal); hasMarkerPlacedRef.current=false },[currentRound,gameLogic,resetTimer,findValidPanorama,playEffect,stopScoreAudio]); useEffect(()=>{ if(showScoreScreen&&gameLogic.score){ stopScoreAdd(); scoreAddStartedRef.current=false; if(hasMarkerPlacedRef.current){ const t=setTimeout(()=>{ if(showScoreScreen&&gameLogic.score&&hasMarkerPlacedRef.current){ scoreAddStartedRef.current=true; startScoreAdd() } },50); return ()=>{ clearTimeout(t); stopScoreAdd() } } } else if(!showScoreScreen){ stopScoreAudio(); scoreAddStartedRef.current=false } },[showScoreScreen,gameLogic.score,currentRound,startScoreAdd,stopScoreAdd,stopScoreAudio]); return (<div className={styles.umbrella} style={styles}><div data-panorama-container ref={panoramaRef} style={{width:"100vw",height:"100vh"}}/><UIOverlay timerText={timerText} currentRound={currentRound}/><ControlOverlay onZoomIn={zoomIn} onZoomOut={zoomOut}/>{!showScoreScreen&&(<GuessMap isLoaded={isLoaded} userGuess={gameLogic.userGuess} onMapClick={handleMapClick} isExpanded={isMapExpanded} onToggleExpand={()=>setIsMapExpanded(p=>!p)} onSubmitGuess={handleSubmitGuess}/>)}<ScoreScreen show={showScoreScreen} score={gameLogic.score} guessInfo={gameLogic.guessInfo} goalPoint={gameLogic.submittedGoal} guessPoint={gameLogic.submittedGuess} isLoaded={isLoaded} onNextRound={startRound} onScoreBarComplete={handleScoreBarComplete} currentRound={currentRound}/></div>) }

